# üöÄ –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ TeleSklad

## üìä –û–±–∑–æ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç

–ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã TeleSklad —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

#### **Purchases API** (`/api/purchases`)
- **–î–æ**: 1 + N –∑–∞–ø—Ä–æ—Å–æ–≤ (N = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—É–ø–æ–∫)
- **–ü–æ—Å–ª–µ**: 2 –∑–∞–ø—Ä–æ—Å–∞ (purchases + count)
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: 10-50x
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `include` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ `purchase_items` –∏ `products`
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è
  - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è BigInt –ø–æ–ª–µ–π

#### **Products Analytics API** (`/api/products/analytics`)
- **–î–æ**: 2N + 3 –∑–∞–ø—Ä–æ—Å–æ–≤ (N = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤)
- **–ü–æ—Å–ª–µ**: 3 –∑–∞–ø—Ä–æ—Å–∞ + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: 18x + –∫—ç—à-—É—Å–∫–æ—Ä–µ–Ω–∏–µ
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - Batch-–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö
  - Batch-–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–∞—Ö –≤ –ø—É—Ç–∏
  - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ Map –¥–ª—è O(1) –ø–æ–∏—Å–∫–∞
  - In-memory –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 10 –º–∏–Ω—É—Ç

#### **POST —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫** (`/api/purchases`)
- **–î–æ**: N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ + N –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **–ü–æ—Å–ª–µ**: 1 –∑–∞–ø—Ä–æ—Å —Ç–æ–≤–∞—Ä–æ–≤ + createMany + batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: 5-10x

### 2. üíæ –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

#### **Analytics Cache** (`src/lib/cache/analytics-cache.ts`)
- **In-memory –∫—ç—à** —Å TTL –∏ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π
- **TTL**: 5-30 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö
- **–†–∞–∑–º–µ—Ä**: –¥–æ 200 –∑–∞–ø–∏—Å–µ–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: hit/miss, —Ä–∞–∑–º–µ—Ä, –≤—Ä–µ–º—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

#### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (10 –º–∏–Ω)
- –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç (30 –º–∏–Ω)
- –°–ø–∏—Å–∫–∏ –∑–∞–∫—É–ø–æ–∫ (2 –º–∏–Ω)

### 3. üóÑÔ∏è –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### **–°–∫—Ä–∏–ø—Ç –∏–Ω–¥–µ–∫—Å–æ–≤** (`scripts/add-database-indexes.sql`)
```sql
-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_purchases_createdat ON purchases(createdat DESC);
CREATE INDEX idx_purchase_items_purchaseid ON purchase_items(purchaseid);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
CREATE INDEX idx_orders_paid_at ON orders(paid_at DESC) WHERE paid_at IS NOT NULL;
-- + 10 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
```

### 4. üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### **–°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** (`scripts/monitor-db-performance.sql`)
- –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à-—Ö–∏—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞
- –ê–Ω–∞–ª–∏–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

## üìä –ò–∑–º–µ—Ä–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API**:
```
GET /api/purchases:
- –î–æ: 1000-3000ms (N+1 –∑–∞–ø—Ä–æ—Å—ã)
- –ü–æ—Å–ª–µ: 200-500ms (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ: 5-15x

GET /api/products/analytics:
- –î–æ: 4000-8000ms (54+ –∑–∞–ø—Ä–æ—Å–æ–≤)
- –ü–æ—Å–ª–µ: 1500-3000ms (3 –∑–∞–ø—Ä–æ—Å–∞) / 50-100ms (–∫—ç—à)
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ: 3-5x (–ë–î) / 40-80x (–∫—ç—à)
```

### **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**:
- **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤**: 80-95%
- **–°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**: 70%
- **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫—ç—à-—Ö–∏—Ç–æ–≤**: 60-90%

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**:
- **–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**: 3-5 —Å–µ–∫—É–Ω–¥ ‚Üí 0.1-1 —Å–µ–∫—É–Ω–¥–∞
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è**: –ø–ª–∞–≤–Ω–∞—è, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –Ω–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### **BigInt —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
```typescript
// –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ BigInt –≤ —Å—Ç—Ä–æ–∫–∏
id: purchase.id ? String(purchase.id) : null,
userid: purchase.userid ? String(purchase.userid) : null,
```

### **–ü–∞–≥–∏–Ω–∞—Ü–∏—è**:
```typescript
// –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ API
{
  purchases: [...],
  pagination: {
    page: 1,
    limit: 50,
    totalCount: 100,
    totalPages: 2,
    hasNextPage: true,
    hasPrevPage: false
  }
}
```

### **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏**:
```typescript
// createMany –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤
await tx.purchase_items.createMany({
  data: purchaseItemsData
});
```

## üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### **–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**:
- 14 –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö .md –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–π
- –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**:
```
‚îú‚îÄ‚îÄ N+1_OPTIMIZATION_REPORT.md (–¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç)
‚îú‚îÄ‚îÄ PERFORMANCE_OPTIMIZATION_COMPLETE.md (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
‚îú‚îÄ‚îÄ scripts/add-database-indexes.sql
‚îú‚îÄ‚îÄ scripts/monitor-db-performance.sql
‚îî‚îÄ‚îÄ src/lib/cache/analytics-cache.ts
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**:
1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î**:
   ```bash
   psql -d production_db -f scripts/add-database-indexes.sql
   ```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   ```bash
   psql -d production_db -f scripts/monitor-db-performance.sql
   ```

3. **–í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**:
   ```sql
   ALTER SYSTEM SET log_min_duration_statement = 1000;
   SELECT pg_reload_conf();
   ```

### **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è** (1-2 –Ω–µ–¥–µ–ª–∏):

1. **Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –í–Ω–µ—à–Ω–∏–π Redis –¥–ª—è –∫—ç—à–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
   - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

2. **Connection pooling**:
   - PgBouncer –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π Prisma

3. **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è UI**:
   - React Window –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
   - –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è** (1-2 –º–µ—Å—è—Ü–∞):

1. **–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è**:
   ```sql
   CREATE MATERIALIZED VIEW products_analytics_daily AS
   SELECT ... -- –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
   ```

2. **CDN –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è**:
   - Next.js ISR –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
   - CDN –¥–ª—è –∞—Å—Å–µ—Ç–æ–≤

3. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
   - –í—ã–¥–µ–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
   - API Gateway –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

### **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏**:
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API (< 1 —Å–µ–∫—É–Ω–¥—ã)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (< 10 –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é)
- –ö—ç—à hit ratio (> 80%)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (< 512MB)

### **–ê–ª–µ—Ä—Ç—ã**:
```yaml
# –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤
alerts:
  - name: "Slow API Response"
    condition: "response_time > 2s"
    action: "notify_team"
  
  - name: "Low Cache Hit Ratio"
    condition: "cache_hit_ratio < 70%"
    action: "check_cache_config"
  
  - name: "High DB Load"
    condition: "active_connections > 50"
    action: "scale_db"
```

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∞ TeleSklad –∏–∑ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å N+1 –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –≤ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

- **80-95% —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î**
- **5-80x —É—Å–∫–æ—Ä–µ–Ω–∏–µ API**
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É –¥–∞–Ω–Ω—ã—Ö**

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –≥–æ—Ç–æ–≤–∞ –∫:
- –£–≤–µ–ª–∏—á–µ–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ 10x
- –†–æ—Å—Ç—É –¥–∞–Ω–Ω—ã—Ö –≤ 100x
- –î–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 19.06.2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è 
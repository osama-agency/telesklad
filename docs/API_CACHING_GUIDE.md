# API Caching Guide

## –û–±–∑–æ—Ä

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ **Stale-While-Revalidate (SWR)**. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- ‚ö° –°–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–æ 70-90%
- üöÄ –£–ª—É—á—à–∏—Ç—å –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (10-50–º—Å –≤–º–µ—Å—Ç–æ 200-500–º—Å)
- üîÑ –û–±–µ—Å–ø–µ—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- üõ°Ô∏è –ü–æ–≤—ã—Å–∏—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã SWR

```
–ó–∞–ø—Ä–æ—Å ‚Üí –ö—ç—à —Å–≤–µ–∂–∏–π? ‚Üí –î–∞ ‚Üí –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –∫—ç—à–∞
                    ‚Üì
                   –ù–µ—Ç ‚Üí –ö—ç—à —É—Å—Ç–∞—Ä–µ–≤—à–∏–π? ‚Üí –î–∞ ‚Üí –í–æ–∑–≤—Ä–∞—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö + –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                                        ‚Üì
                                       –ù–µ—Ç ‚Üí –ó–∞–ø—Ä–æ—Å –∫ –ë–î ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–∏–ø—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | s-maxage | stale-revalidate | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|------------------|----------|
| **PUBLIC_STATIC** | 300—Å (5–º) | 600—Å (10–º) | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| **PUBLIC_DYNAMIC** | 60—Å (1–º) | 300—Å (5–º) | –ü—Ä–æ–¥—É–∫—Ç—ã, —Ü–µ–Ω—ã |
| **PRIVATE_STATIC** | 30—Å | 60—Å (1–º) | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **PRIVATE_DYNAMIC** | 15—Å | 30—Å | –ó–∞–∫–∞–∑—ã, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ |
| **REAL_TIME** | 10—Å | 30—Å | –õ–æ—è–ª—å–Ω–æ—Å—Ç—å, –±–æ–Ω—É—Å—ã |

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ Cache-Control

```http
# –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
Cache-Control: public, s-maxage=60, stale-while-revalidate=300

# –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ  
Cache-Control: private, s-maxage=30, stale-while-revalidate=60
```

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### ‚úÖ –£–∂–µ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

| –≠–Ω–¥–ø–æ–∏–Ω—Ç | –¢–∏–ø –∫—ç—à–∞ | TTL | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|-----|----------|
| `GET /api/webapp/products` | PUBLIC_DYNAMIC | 60—Å/300—Å | –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ |
| `GET /api/webapp/categories` | PUBLIC_STATIC | 300—Å/600—Å | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ |
| `GET /api/webapp/loyalty` | REAL_TIME | 10—Å/30—Å | –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ |
| `GET /api/webapp/profile` | PRIVATE_STATIC | 30—Å/60—Å | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `GET /api/webapp/orders` | PRIVATE_DYNAMIC | 15—Å/30—Å | –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ |
| `GET /api/webapp/favorites` | PRIVATE_DYNAMIC | 30—Å/60—Å | –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã |

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ò–º–ø–æ—Ä—Ç

```typescript
import { createCachedResponse, CacheType, getCachePreset } from '@/lib/cache';
```

### –ü—Ä–æ—Å—Ç–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```typescript
export async function GET() {
  try {
    const data = await fetchData();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —Ç–∏–ø—É –¥–∞–Ω–Ω—ã—Ö
    const cacheOptions = getCachePreset(CacheType.PRODUCTS);
    return createCachedResponse(data, cacheOptions);
    
  } catch (error) {
    return NextResponse.json({ error: 'Failed' }, { status: 500 });
  }
}
```

### –ö–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```typescript
import { cacheHeaders } from '@/lib/cache';

export async function GET() {
  const data = await fetchData();
  
  const headers = cacheHeaders({
    sMaxAge: 120,
    staleRevalidate: 240,
    isPrivate: false
  });
  
  return new Response(JSON.stringify(data), { status: 200, headers });
}
```

## –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö

```typescript
// –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
export async function PUT(req: Request) {
  try {
    const updatedProduct = await updateProduct(data);
    
    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Next.js 13.4+)
    revalidateTag('products');
    
    return NextResponse.json(updatedProduct);
  } catch (error) {
    // ...
  }
}
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö TTL –¥–ª—è —á–∞—Å—Ç–æ –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```typescript
// –î–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
const headers = cacheHeaders({
  sMaxAge: 5,  // –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π TTL
  staleRevalidate: 15,
  isPrivate: true
});
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

```bash
curl -I https://yourapp.com/api/webapp/products
```

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: public, s-maxage=60, stale-while-revalidate=300
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞

```typescript
export async function GET() {
  const startTime = Date.now();
  const data = await fetchData();
  const queryTime = Date.now() - startTime;
  
  console.log(`API query took ${queryTime}ms`);
  
  return createCachedResponse(data, getCachePreset(CacheType.PRODUCTS));
}
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `public` –¥–ª—è –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `private` –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–µ TTL –¥–ª—è —á–∞—Å—Ç–æ –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production-–æ–∫—Ä—É–∂–µ–Ω–∏–∏

### ‚ùå –ß–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å

- –ù–µ –∫—ç—à–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ `public`
- –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ TTL –¥–ª—è –¥–∏–Ω–∞–º–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ–± –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –∫—ç—à–∏—Ä—É–π—Ç–µ POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å—ã

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 200-500–º—Å
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: 100% –∑–∞–ø—Ä–æ—Å–æ–≤
- RPS: ~50-100

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 10-50–º—Å (–∏–∑ –∫—ç—à–∞)
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: 10-30% –∑–∞–ø—Ä–æ—Å–æ–≤
- RPS: ~300-500

### –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- **–ë–î –∑–∞–ø—Ä–æ—Å—ã**: ‚Üì70-90%
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞**: ‚Üì80-90%
- **–°–µ—Ä–≤–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: ‚Üì60-80%

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å CDN

–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å:
- ‚úÖ Vercel Edge Network
- ‚úÖ Cloudflare
- ‚úÖ AWS CloudFront
- ‚úÖ Nginx proxy_cache

## Troubleshooting

### –ö—ç—à –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12 ‚Üí Network)
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GET-–º–µ—Ç–æ–¥
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CDN/–ø—Ä–æ–∫—Å–∏

### –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ
1. –£–º–µ–Ω—å—à–∏—Ç–µ `s-maxage`
2. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `revalidateTag()` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î
1. –£–≤–µ–ª–∏—á—å—Ç–µ `stale-while-revalidate`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫—ç—à –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è 
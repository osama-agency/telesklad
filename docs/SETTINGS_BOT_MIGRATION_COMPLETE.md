# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ settings_bot

## üìã –û–±–∑–æ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏

–£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–æ–¥–µ–ª–∏ `settings_bot` –≤ –º–æ–¥–µ–ª—å `settings` –∏ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Grammy —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–º.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω SQL —Å–∫—Ä–∏–ø—Ç `migrate-bot-settings-to-settings.sql` 
- ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `settings_bot` –≤ `settings`
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `settings_bot` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `settings_bot` –∏–∑ Prisma —Å—Ö–µ–º—ã

### 2. –°–æ–∑–¥–∞–Ω–∏–µ SettingsService
- ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å `SettingsService.ts`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Redis
- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è Grammy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `GrammyBotWorker` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `SettingsService`
- ‚úÖ –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `TelegramTokenService`
- ‚úÖ –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test-settings-migration.ts`
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Grammy –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫...

1Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SettingsService...
‚úÖ admin_chat_id: -1002291288806
‚úÖ grammy_enabled: true  
‚úÖ delivery_cost: 0

2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ getBotSettings()...
‚úÖ client_bot_token: ***–∑–∞–ø–æ–ª–Ω–µ–Ω***
‚úÖ admin_bot_token: ***–∑–∞–ø–æ–ª–Ω–µ–Ω***
‚úÖ admin_chat_id: -1002291288806
‚úÖ courier_tg_id: 7690550402
‚úÖ grammy_enabled: true
‚úÖ welcome_message: Strattera Bot ‚Äî –≤–∞—à —É–¥–æ–±–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω –≤–∏—Ç–∞–º–∏–Ω–æ–≤, –ë–ê–î...

3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Grammy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...
‚úÖ clientBotToken: ***–∑–∞–ø–æ–ª–Ω–µ–Ω***
‚úÖ adminBotToken: ***–∑–∞–ø–æ–ª–Ω–µ–Ω***
‚úÖ webhookUrl: https://strattera.ngrok.app/api/telegram/grammy-simple/webhook
‚úÖ grammyEnabled: true
‚úÖ adminChatId: -1002291288806
‚úÖ courierTgId: 7690550402

4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Grammy...
‚úÖ Grammy –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ: –î–ê ‚úÖ

üöÄ –°–∏—Å—Ç–µ–º—É –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–Ω!
```

## üóÇÔ∏è –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –¢–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤
- `client_bot_token` - –¢–æ–∫–µ–Ω –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞ (7754514670:AAFswWZxch4OwaLcmQp7LMzr6E3AdJ5woPg)
- `admin_bot_token` - –¢–æ–∫–µ–Ω –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –±–æ—Ç–∞ (7612206140:AAHA6sV7VZLyUu0Ua1DAoULiFYehAjJK4)

### ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- `admin_chat_id` - ID –∞–¥–º–∏–Ω–∞ (-1002291288806)
- `courier_tg_id` - ID –∫—É—Ä—å–µ—Ä–∞ (7690550402)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ webhook
- `webhook_url` - URL –¥–ª—è webhook (https://strattera.ngrok.app/api/telegram/grammy-simple/webhook)
- `webhook_max_connections` - –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (40)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Grammy
- `grammy_enabled` - –í–∫–ª—é—á–µ–Ω (true)
- `grammy_webhook_endpoint` - Endpoint (/api/telegram/grammy-simple/webhook) 
- `grammy_rate_limit` - Rate limit (30)
- `grammy_timeout` - Timeout (5000ms)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `notifications_enabled` - –í–∫–ª—é—á–µ–Ω—ã (true)
- `admin_notifications` - –ê–¥–º–∏–Ω—É (true)
- `courier_notifications` - –ö—É—Ä—å–µ—Ä—É (true)
- `client_notifications` - –ö–ª–∏–µ–Ω—Ç–∞–º (true)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- `free_delivery_threshold` - –°—É–º–º–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (5000)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `maintenance_mode` - –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (false)
- `debug_mode` - –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (false)
- `log_level` - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (info)
- `environment` - –û–∫—Ä—É–∂–µ–Ω–∏–µ (development)

## üîß API SettingsService

### –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
await SettingsService.get('variable_name', 'default_value')

// –ü–æ–ª—É—á–∏—Ç—å boolean –∑–Ω–∞—á–µ–Ω–∏–µ  
await SettingsService.getBoolean('variable_name', false)

// –ü–æ–ª—É—á–∏—Ç—å —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
await SettingsService.getNumber('variable_name', 0)

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
await SettingsService.set('variable_name', 'value', 'description')
```

### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
```typescript
// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–æ–≤
const settings = await SettingsService.getBotSettings()

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Grammy
const config = await SettingsService.getGrammyConfig()

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å Grammy
const isReady = await SettingsService.isGrammyReady()

// –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –Ω–∞—Å—Ç—Ä–æ–µ–∫
await SettingsService.clearCache()
```

## üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
```bash
npx tsx scripts/test-settings-migration.ts
```

### 2. –ó–∞–ø—É—Å–∫ –≤ development
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Next.js
pkill -f "next dev"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Next.js –Ω–∞ –ø–æ—Ä—Ç—É 3000
PORT=3000 npm run dev

# –ó–∞–ø—É—Å—Ç–∏—Ç—å ngrok (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
ngrok http --domain=strattera.ngrok.app 3000

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
npm run telegram:webhook:setup
```

### 3. Endpoint'—ã Grammy
- **Webhook:** `/api/telegram/grammy-simple/webhook`
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** `/api/telegram/grammy/info`
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** `/api/telegram/grammy/test`

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: SettingsService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (TTL: 5 –º–∏–Ω—É—Ç)

2. **Fallback**: –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –≤ –ø–∞–º—è—Ç–∏

3. **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í—Å–µ –º–µ—Ç–æ–¥—ã —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫

4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

5. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –°–æ–∑–¥–∞–Ω–æ
- `src/lib/services/SettingsService.ts` - –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `scripts/migrate-bot-settings-to-settings.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `scripts/test-settings-migration.ts` - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `docs/SETTINGS_BOT_MIGRATION_COMPLETE.md` - –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–æ
- `prisma/schema.prisma` - –£–¥–∞–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å settings_bot
- `src/lib/services/grammy/GrammyBotWorker.ts` - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SettingsService

### –£–¥–∞–ª–µ–Ω–æ
- `scripts/check-both-settings.ts` - –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
- –¢–∞–±–ª–∏—Ü–∞ `settings_bot` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–Ω

‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É –≤ –ø—Ä–æ–¥–∞–∫—à–Ω:**

- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –±–µ–∑ –ø–æ—Ç–µ—Ä—å
- Grammy –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω  
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –¢–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã
- –ö–æ–¥ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω

üöÄ **–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç—ã –∏ webhook'–∏!**

---

*–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: 2025-01-27*  
*–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ‚úÖ –£—Å–ø–µ—à–Ω–æ*
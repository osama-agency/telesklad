# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "ReadableStream is locked" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (`/webapp/favorites`) –ø–æ—è–≤–ª—è–ª–∞—Å—å –æ—à–∏–±–∫–∞:
```
[Error: failed to pipe response] {
  [cause]: [TypeError: Invalid state: The ReadableStream is locked] {
    code: 'ERR_INVALID_STATE'
  }
}
```

## –ü—Ä–∏—á–∏–Ω–∞

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–µ–ª–∞–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∫ API:
   - `FavoritesContext` - –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `pathname` 
   - `FavoritesPage` - –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   - –í–æ–∑–º–æ–∂–Ω–æ –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –∏–µ—Ä–∞—Ä—Ö–∏–∏

2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π**: –§—É–Ω–∫—Ü–∏—è `dedupeRequest` –≤ `/api/webapp/favorites` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ Promise —Å `NextResponse`. –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `NextResponse` —Å–æ–∑–¥–∞–µ—Ç ReadableStream, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –ö–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –∫–ª–∏–µ–Ω—Ç —á–∏—Ç–∞–ª stream, –æ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ API

**–§–∞–π–ª**: `src/app/api/webapp/favorites/route.ts`

–ò–∑–º–µ–Ω–∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é `dedupeRequest` —á—Ç–æ–±—ã –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ `NextResponse`:

```typescript
// –î–æ:
return await dedupeRequest(`favorites:${tgId}`, async () => {
  // ...
  return NextResponse.json(cached);
});

// –ü–æ—Å–ª–µ:
const data = await dedupeRequest<FavoritesResult>(`favorites:${tgId}`, async () => {
  // ...
  return cached; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ Response
});

// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—ã–π Response –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞
return NextResponse.json(data);
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è FavoritesContext

**–§–∞–π–ª**: `src/context/FavoritesContext.tsx`

–î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –¥–µ–ª–∞–ª –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:

```typescript
useEffect(() => {
  // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∞–º–∞ –∑–∞–≥—Ä—É–∑–∏—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
  if (pathname === '/webapp/favorites') {
    console.log('üîÑ FavoritesContext: Skipping load on favorites page');
    return;
  }
  
  loadFavoritesCount();
}, [isAuthenticated, user?.tg_id, pathname]);
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

1. –û—à–∏–±–∫–∞ "ReadableStream is locked" –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API —Å–æ–∫—Ä–∞—â–µ–Ω–æ
3. –ú–µ—Ö–∞–Ω–∏–∑–º –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π Response –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞ –∑–∞ —Å—á–µ—Ç —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- ReadableStream –≤ Web API –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- NextResponse —Å–æ–∑–¥–∞–µ—Ç ReadableStream –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞
- –ü—Ä–∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–∞–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∞ –Ω–µ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ stream
- TypeScript —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –¥–ª—è generic —Ñ—É–Ω–∫—Ü–∏–π

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

28 —è–Ω–≤–∞—Ä—è 2025 –≥. 
# Интеграция DaData в Next.js WebApp

Этот документ описывает интеграцию сервиса DaData для автоподсказок адресов и ФИО в webapp.

## Настройка

### 1. Получение API ключей

1. Зарегистрируйтесь на [dadata.ru](https://dadata.ru)
2. Подтвердите email
3. Получите API-ключ в личном кабинете
4. Для стандартизации данных также понадобится секретный ключ

### 2. Переменные окружения

Добавьте в `.env.local`:

```env
DADATA_TOKEN=your_dadata_api_token_here
DADATA_SECRET=your_dadata_secret_key_here
```

### 3. Лимиты бесплатного тарифа

- **10,000 запросов в день** бесплатно
- Подсказки по адресам, ФИО, организациям, банкам, email
- Максимум 30 запросов в секунду

## Архитектура решения

### 1. API Routes (Server-side)

- `/api/webapp/dadata/address` - подсказки адресов
- `/api/webapp/dadata/fio` - подсказки ФИО

**Преимущества серверного подхода:**
- Безопасность API ключей
- Кэширование на сервере
- Контроль лимитов
- Единая точка для мониторинга

### 2. React Hooks

- `useDaDataAddress()` - для работы с адресами
- `useDaDataFIO()` - для работы с ФИО

**Возможности:**
- Debounce запросов (300ms)
- Отмена предыдущих запросов
- Обработка ошибок
- Loading состояния

### 3. Компонент DaDataInput

Универсальный компонент с автоподсказками:

```tsx
<DaDataInput
  type="address"
  addressType="city"
  value={city}
  onChange={(value, data) => {
    setCity(value);
    if (data?.postal_code) {
      setPostalCode(data.postal_code);
    }
  }}
  placeholder="Введите город"
  required
/>
```

## Функциональность

### Подсказки адресов

- **Города**: полнотекстовый поиск по всем городам России
- **Улицы**: контекстный поиск в рамках выбранного города
- **Автозаполнение**: индекс, дом, квартира при выборе полного адреса

### Подсказки ФИО

- **Фамилии**: с учетом популярности
- **Имена**: с определением пола
- **Отчества**: контекстно к выбранному имени

### Автозаполнение полей

При выборе подсказки автоматически заполняются связанные поля:

**Адрес:**
- Город → Почтовый индекс
- Улица + дом → Индекс, квартира, корпус

**ФИО:**
- Имя → Определение пола для дальнейших подсказок

## Использование в формах

### DeliveryForm

Форма доставки использует DaData для:
- Поля "Город" - подсказки городов
- Поля "Улица" - подсказки улиц в контексте города
- Поля "Фамилия" и "Имя" - подсказки ФИО

### Клавиатурная навигация

- `↓` / `↑` - навигация по подсказкам
- `Enter` - выбор подсказки
- `Escape` - закрыть подсказки

## Стили

Стили подсказок наследуют дизайн из старого Rails проекта:

- Выпадающий список с фоном `#f6f6f6`
- Hover эффекты с зеленым цветом `#48C928`
- Кастомный скроллбар в стиле webapp
- Адаптивность для мобильных устройств

## API Endpoints

### POST /api/webapp/dadata/address

```json
{
  "query": "москва сухон",
  "count": 10
}
```

**Ответ:**
```json
{
  "suggestions": [
    {
      "value": "г Москва, ул Сухонская",
      "unrestricted_value": "127642, г Москва, ул Сухонская",
      "data": {
        "postal_code": "127642",
        "region": "Москва",
        "city": "Москва",
        "street": "Сухонская",
        ...
      }
    }
  ]
}
```

### POST /api/webapp/dadata/fio

```json
{
  "query": "иван",
  "parts": ["NAME"],
  "gender": "MALE",
  "count": 10
}
```

**Ответ:**
```json
{
  "suggestions": [
    {
      "value": "Иван",
      "data": {
        "surname": null,
        "name": "Иван",
        "patronymic": null,
        "gender": "MALE"
      }
    }
  ]
}
```

## Обработка ошибок

1. **Сетевые ошибки** - показ сообщения пользователю
2. **Лимиты API** - graceful degradation
3. **Некорректные данные** - валидация на сервере

## Оптимизация

1. **Debounce** - задержка 300ms перед запросом
2. **Cancellation** - отмена предыдущих запросов
3. **Минимальная длина** - запросы от 2 символов
4. **Кэширование** - на уровне браузера и сервера

## Безопасность

- API ключи только на сервере
- Валидация всех входящих данных
- Rate limiting на API routes
- Санитизация ответов от DaData

## Мониторинг

Рекомендуется отслеживать:
- Количество запросов к DaData
- Ошибки API
- Время ответа
- Использование лимитов

## Расширение функциональности

Система легко расширяется для добавления:
- Подсказок организаций
- Подсказок банков
- Валидации email
- Стандартизации данных

## Fallback

При недоступности DaData:
- Поля остаются обычными input
- Функциональность не нарушается
- Пользователь может вводить данные вручную 
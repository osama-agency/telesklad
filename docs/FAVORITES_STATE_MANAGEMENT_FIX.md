# Исправление проблемы с состоянием избранного

## Проблема

При добавлении товара в избранное на одной карточке, другие карточки товаров не обновлялись корректно. Сердечки не синхронизировались между разными товарами.

## Анализ причин

### 1. Двойное оптимистическое обновление
- В `FavoriteButton` было локальное состояние `optimisticFavoriteState`
- В `FavoritesContext` также было оптимистическое обновление
- Эти два состояния конфликтовали друг с другом

### 2. Сложная синхронизация
- `FavoriteButton` пытался синхронизировать локальное состояние с глобальным
- Использовались `useEffect` для отслеживания изменений
- Это приводило к рассинхронизации состояний

### 3. Событийная система
- Использовался `window.dispatchEvent('favoritesUpdated')`
- Это могло создавать циклы обновлений
- Добавляло ненужную сложность

## Решение

### 1. Единый источник истины
```typescript
// ДО (в FavoriteButton)
const isFavorite = optimisticFavoriteState !== null ? optimisticFavoriteState : favoriteIds.includes(productId);

// ПОСЛЕ
const isFavorite = favoriteIds.includes(productId);
```

### 2. Упрощение FavoriteButton
- Убрано локальное состояние `optimisticFavoriteState`
- Убраны `useEffect` для синхронизации
- Компонент теперь полагается только на состояние из контекста

### 3. Оптимизация контекста
- Добавлены `useCallback` для функций
- Убрана событийная система
- Улучшена обработка ошибок

## Изменения в коде

### FavoriteButton.tsx
```typescript
// Убрано
const [optimisticFavoriteState, setOptimisticFavoriteState] = useState<boolean | null>(null);

// Упрощено
const isFavorite = favoriteIds.includes(productId);

// Убрана сложная логика синхронизации
// Теперь просто вызывается toggleFavorite из контекста
```

### FavoritesContext.tsx
```typescript
// Добавлены useCallback для оптимизации
const loadFavorites = useCallback(async () => { ... }, [isAuthenticated, user?.tg_id, authLoading]);
const toggleFavorite = useCallback(async (productId: number) => { ... }, [favoriteIds, user?.tg_id]);

// Убрана событийная система
// window.dispatchEvent(new Event("favoritesUpdated")); - удалено
```

## Преимущества нового подхода

### 1. Простота
- Один источник истины (FavoritesContext)
- Меньше состояний для отслеживания
- Прямая связь между компонентами и контекстом

### 2. Надежность
- Нет конфликтов между состояниями
- Автоматическая синхронизация всех компонентов
- Лучшая обработка ошибок

### 3. Производительность
- useCallback предотвращает ненужные ререндеры
- Меньше useEffect'ов
- Оптимизированные зависимости

## Тестирование

Для проверки исправления:

1. Откройте каталог товаров
2. Добавьте первый товар в избранное (сердечко должно стать красным)
3. Добавьте второй товар в избранное
4. Проверьте, что оба сердечка остаются красными
5. Удалите один товар из избранного
6. Проверьте, что изменения корректно отображаются на всех карточках

## Архитектура состояния

```
FavoritesContext (единый источник истины)
    ↓
favoriteIds: number[]
    ↓
FavoriteButton (получает состояние из контекста)
    ↓
isFavorite = favoriteIds.includes(productId)
```

## Заключение

Исправление убрало сложную логику синхронизации состояний и сделало систему избранного более простой и надежной. Теперь все компоненты автоматически синхронизируются через единый контекст без дополнительных усилий. 
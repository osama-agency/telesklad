# Исправление проблемы с расчетом суммы заказа

## Проблема

В сообщениях Telegram бота сумма к оплате отображалась как конкатенация строк вместо математического сложения:
- **Неправильно:** `5200₽ + 500₽ = 5200500₽`
- **Правильно:** `5200₽ + 500₽ = 5700₽`

## Причина

В файле `src/lib/services/ReportService.ts` происходила конкатенация строк вместо арифметического сложения:

```typescript
// БЫЛО (неправильно):
const totalToPay = order.total_amount + deliveryCost;

// СТАЛО (правильно):
const totalToPay = Number(order.total_amount) + Number(deliveryCost);
```

## Исправленные места

1. **Метод `onUnpaid` (строка 100):** Расчет суммы при создании заказа
2. **Метод `onPaid` (строка 149):** Расчет суммы при подтверждении оплаты

## Типичная ошибка JavaScript

Это классическая ошибка JavaScript, когда оператор `+` выполняет конкатенацию строк вместо арифметического сложения, если хотя бы один из операндов является строкой.

### Примеры:
```javascript
// Конкатенация (неправильно):
"5200" + "500" = "5200500"
5200 + "500" = "5200500"

// Арифметическое сложение (правильно):
Number("5200") + Number("500") = 5700
parseInt("5200") + parseInt("500") = 5700
+("5200") + +("500") = 5700
```

## Проверка исправления

После исправления сообщения Telegram бота должны отображать корректную сумму:

```
Состав заказа:
• Atominex 18 mg — 1шт. — 5200₽
• Доставка — услуга — 500₽

Сумма к оплате: 5700₽  ← Исправлено!
```

## Профилактика

Для предотвращения подобных ошибок в будущем:

1. **Всегда явно преобразовывать типы** при арифметических операциях
2. **Использовать TypeScript** для строгой типизации
3. **Добавить unit-тесты** для критических расчетов
4. **Code review** для выявления подобных проблем

## Дата исправления

24 декабря 2024 г. 
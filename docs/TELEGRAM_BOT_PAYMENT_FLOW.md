# –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

## –û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–Ø –æ–ø–ª–∞—Ç–∏–ª" –≤ Telegram –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:

## 1. –ü–æ–ª—É—á–µ–Ω–∏–µ callback –æ—Ç Telegram

```
üì® Telegram ‚Üí Webhook ‚Üí TelegramBotWorker.handleCallback()
```

- Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback_query –Ω–∞ webhook endpoint `/api/telegram/webhook`
- Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç `TelegramBotWorker.processWebhookUpdate()`
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–∏–ø callback: `i_paid`

## 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ callback "i_paid"

```typescript
TelegramBotWorker.handleIPaid() {
  1. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ tg_id
  2. –ü–∞—Ä—Å–∏—Ç –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
  3. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ 1 (paid)
  4. –í—ã–∑—ã–≤–∞–µ—Ç ReportService.handleOrderStatusChange()
  5. –û—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é "–°–ø–∞—Å–∏–±–æ! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã."
}
```

## 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ ReportService

```typescript
ReportService.onPaid() {
  1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É: "paid_client" - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
  2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω—É: "paid_admin" - –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É"
}
```

## 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–æ–º

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∞–¥–º–∏–Ω–æ–º –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É":

```typescript
TelegramBotWorker.handleApprovePayment() {
  1. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ 2 (processing)
  2. –í—ã–∑—ã–≤–∞–µ—Ç ReportService.handleOrderStatusChange()
  3. –£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ –∞–¥–º–∏–Ω–∞
}
```

## 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞

```typescript
ReportService.onProcessing() {
  1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—É—Ä—å–µ—Ä—É –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä"
  2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞
}
```

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```mermaid
sequenceDiagram
    participant C as –ö–ª–∏–µ–Ω—Ç
    participant T as Telegram
    participant W as Webhook
    participant B as BotWorker
    participant R as ReportService
    participant A as –ê–¥–º–∏–Ω
    participant K as –ö—É—Ä—å–µ—Ä

    C->>T: –ù–∞–∂–∏–º–∞–µ—Ç "–Ø –æ–ø–ª–∞—Ç–∏–ª"
    T->>W: callback_query (i_paid)
    W->>B: processWebhookUpdate()
    B->>B: handleIPaid()
    B->>B: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ PAID
    B->>R: handleOrderStatusChange()
    R->>C: "–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
    R->>A: "–ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω" + –∫–Ω–æ–ø–∫–∞
    
    A->>T: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É"
    T->>W: callback_query (approve_payment)
    W->>B: processWebhookUpdate()
    B->>B: handleApprovePayment()
    B->>B: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ PROCESSING
    B->>R: handleOrderStatusChange()
    R->>K: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑" + –∫–Ω–æ–ø–∫–∞
    R->>C: "–ó–∞–∫–∞–∑ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ"
```

## –û—Ç–ª–∞–¥–∫–∞

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏:

1. **Webhook –ø–æ–ª—É—á–µ–Ω–∏–µ**: `üì® Telegram webhook update:`
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ callback**: `üì≤ Callback: i_paid from ...`
3. **ReportService**: `üìä ReportService: Order X status changed from Y to Z`
4. **TelegramService**: `üì§ TelegramService.call:`
5. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π**: `‚úÖ Message sent to ...`

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ö–Ω–æ–ø–∫–∞ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç**:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É webhook: `npm run telegram:webhook:info`
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ ngrok –∑–∞–ø—É—â–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

2. **–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ –ë–î
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å tg_id
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î

3. **–°—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞–∫–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ 
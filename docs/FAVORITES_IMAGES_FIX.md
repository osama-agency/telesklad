# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

–í —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (`/tgapp/favorites`) –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Ö–æ—Ç—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

### –°–∏–º–ø—Ç–æ–º—ã:
- ‚úÖ **–ö–∞—Ç–∞–ª–æ–≥**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ S3 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ùå **–ò–∑–±—Ä–∞–Ω–Ω–æ–µ**: –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∏ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- üîç **–í –ª–æ–≥–∞—Ö**: –†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ API

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ API –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (`/api/webapp/favorites`)

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–±—ã–ª–æ):
let imageUrl = product?.image_url;
if (!imageUrl && blobKey) {
  imageUrl = S3Service.getImageUrl(blobKey);
}
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ API –ø—Ä–æ–¥—É–∫—Ç–æ–≤:**

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (—Å—Ç–∞–ª–æ):
const activeStorageUrl = imageMap.get(productId);
const imageUrl = activeStorageUrl || product?.image_url;
```

### –†–∞–∑–ª–∏—á–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö

| –ê—Å–ø–µ–∫—Ç | API –ø—Ä–æ–¥—É–∫—Ç–æ–≤ | API –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (–±—ã–ª–æ) | API –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (—Å—Ç–∞–ª–æ) |
|--------|---------------|----------------------|----------------------|
| **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** | ActiveStorage ‚Üí image_url | image_url ‚Üí ActiveStorage | ActiveStorage ‚Üí image_url |
| **–°–æ–∑–¥–∞–Ω–∏–µ URL** | `S3Service.getImageUrl(key)` | `S3Service.getImageUrl(key)` | `S3Service.getImageUrl(key)` |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ü–æ–¥—Ä–æ–±–Ω–æ–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | –ü–æ–¥—Ä–æ–±–Ω–æ–µ |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ù–µ—Ç | –ï—Å—Ç—å (2 –º–∏–Ω) | –ï—Å—Ç—å (2 –º–∏–Ω) |

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ

### 1. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–î–æ:**
```typescript
// –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É product_id -> blob_key
const imageMap = new Map<number, string>();
attachments.forEach(attachment => {
  imageMap.set(Number(attachment.record_id), attachment.active_storage_blobs.key);
});

// –í –º–∞–ø–ø–∏–Ω–≥–µ —Ç–æ–≤–∞—Ä–æ–≤:
const blobKey = imageMap.get(productId);
let imageUrl = product?.image_url;
if (!imageUrl && blobKey) {
  imageUrl = S3Service.getImageUrl(blobKey);
}
```

**–ü–æ—Å–ª–µ:**
```typescript
// –°–æ–∑–¥–∞–µ–º –º–∞–ø—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ product_id (–∫–∞–∫ –≤ API –ø—Ä–æ–¥—É–∫—Ç–æ–≤)
const imageMap = new Map<number, string>();
console.log(`üì¶ Found ${attachments.length} attachments for favorites`);
attachments.forEach(attachment => {
  const imageUrl = S3Service.getImageUrl(attachment.active_storage_blobs.key);
  const productId = Number(attachment.record_id);
  console.log(`üì¶ Mapping favorite product ${productId} to image: ${imageUrl}`);
  imageMap.set(productId, imageUrl);
});

// –í –º–∞–ø–ø–∏–Ω–≥–µ —Ç–æ–≤–∞—Ä–æ–≤:
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ –≤ API –ø—Ä–æ–¥—É–∫—Ç–æ–≤:
// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ActiveStorage –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞—Ç–µ–º image_url –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
const activeStorageUrl = imageMap.get(productId);
const imageUrl = activeStorageUrl || product?.image_url;
```

### 2. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

```typescript
console.log(`üì¶ Found ${attachments.length} attachments for favorites`);
console.log(`üì¶ Mapping favorite product ${productId} to image: ${imageUrl}`);
```

### 3. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

```bash
redis-cli DEL "webapp:favorites:125861752"
```

## üì± –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º: –∑–∞–≥–ª—É—à–∫–∏ –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- –†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ API –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ActiveStorage ‚Üí image_url
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫:

- [x] –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–º, —á—Ç–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
- [x] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [x] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] Fallback –Ω–∞ image_url —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ActiveStorage

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```bash
# –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
redis-cli DEL "webapp:favorites:*"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ API
curl "http://localhost:3000/api/webapp/favorites?tg_id=125861752"

# –°—Ä–∞–≤–Ω–∏—Ç—å —Å API –ø—Ä–æ–¥—É–∫—Ç–æ–≤
curl "http://localhost:3000/api/webapp/products?tg_id=125861752"
```

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### `src/app/api/webapp/favorites/route.ts`
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å API –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –ò–∑–º–µ–Ω–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ActiveStorage ‚Üí image_url
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞–ø—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## üöÄ –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ:
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–æ –≤—Å–µ—Ö API
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **–û—Ç–ª–∞–¥–∫–∞**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –û—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ (2 –º–∏–Ω—É—Ç—ã)
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –¢–∞ –∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–∞–º—è—Ç—å**: –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç

## üîÆ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
2. **–¢–µ—Å—Ç—ã**: –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
3. **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: –£–ª—É—á—à–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-27  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ 
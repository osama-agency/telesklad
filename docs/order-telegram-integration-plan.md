# План реализации сценария оформления заказа с интеграцией Telegram-бота

## 1. Frontend (src/app/webapp/cart/page.tsx)
- Клиент собирает заказ в вебапп и нажимает кнопку "Оформить заказ" в корзине.
- Отправляется запрос на API POST /api/webapp/orders с данными корзины и доставки.
- После успешного создания заказа вебапп сразу закрывается через Telegram WebApp API.
- В Telegram-бот клиенту отправляется сообщение с реквизитами оплаты, которые подставляются по очереди из базы активных банковских карт.
- В сообщении клиенту есть кнопка "Я оплатил".

## 2. Backend (src/app/api/webapp/orders/route.ts)
- При создании заказа в транзакции:
  - Автоматический выбор активной банковской карты из базы (BankCard.active) по очереди для каждого нового заказа.
  - Создание заказа и позиций заказа.
- После создания заказа вызывается ReportService.handleOrderStatusChange с новым заказом и предыдущим статусом (например, -1), чтобы запустить сценарий уведомлений.

## 3. Сервис уведомлений (src/lib/services/ReportService.ts)
- При статусе "unpaid":
  - Клиенту отправляется сообщение с реквизитами и кнопкой "Я оплатил".
  - Админу отправляется сообщение с информацией о заказе и кнопкой "Оплата пришла".
- При нажатии админом кнопки "Оплата пришла":
  - Клиенту отправляется подтверждение оплаты.
  - Курьеру отправляется заказ с кнопкой "Отправить трек-номер".

## 4. Telegram-бот (src/lib/services/TelegramService.ts и TelegramBotWorker)
- Курьер нажимает кнопку "Отправить трек-номер", бот отправляет ему сообщение с инструкцией: "Вставьте трек-номер для клиента ФИО, заказ НОМЕР в следующем сообщении и отправьте мне".
- Курьер отправляет трек-номер, бот обновляет заказ (статус shipped) и пересылает трек-номер клиенту.
- Клиент получает уведомление с трек-номером.

## 5. Дополнительно
- Обеспечить корректное хранение и циклическое использование активных банковских карт.
- Логирование и обработка ошибок.
- Возможность расширения и изменения шаблонов сообщений через i18n или базу данных.

---

## Mermaid диаграмма

```mermaid
flowchart TD
  subgraph Frontend
    A1[Клиент собирает заказ]
    A2[Нажимает "Оформить заказ"]
    A3[POST /api/webapp/orders с данными]
    A4[Закрытие Telegram WebApp]
  end

  subgraph Backend
    B1[Получение запроса создания заказа]
    B2[Выбор активной банковской карты (циклически)]
    B3[Создание заказа и позиций в транзакции]
    B4[Вызов ReportService.handleOrderStatusChange]
  end

  subgraph ReportService
    R1[Обработка статуса "unpaid"]
    R2[Отправка реквизитов клиенту с кнопкой "Я оплатил"]
    R3[Отправка информации админу с кнопкой "Оплата пришла"]
    R4[Обработка статуса "paid" и "processing"]
    R5[Отправка уведомлений клиенту и курьеру]
  end

  subgraph TelegramBotWorker
    T1[Обработка callback "i_paid"]
    T2[Обновление статуса заказа на "paid"]
    T3[Обработка callback "approve_payment"]
    T4[Обновление статуса заказа на "processing"]
    T5[Обработка callback "submit_tracking"]
    T6[Запрос трек-номера у курьера]
    T7[Обработка сообщения с трек-номером]
    T8[Обновление заказа на "shipped" и уведомление клиента]
  end

  A1 --> A2 --> A3 --> B1 --> B2 --> B3 --> B4 --> R1 --> R2 & R3
  R3 --> T1 --> T2 --> R4 --> R5
  R5 --> T3 --> T4 --> T5 --> T6 --> T7 --> T8
  A3 --> A4
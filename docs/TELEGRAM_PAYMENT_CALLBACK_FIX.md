# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback'–∞ "–Ø –æ–ø–ª–∞—Ç–∏–ª"

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. –û—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BigInt –≤ Redis

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
‚ùå Failed to add notification job: TypeError: Do not know how to serialize a BigInt
‚ùå Redis setUserData error: TypeError: Do not know how to serialize a BigInt
```

**–ü—Ä–∏—á–∏–Ω–∞:** JavaScript BigInt –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω –≤ JSON –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `serializeBigInt()` –≤ `RedisQueueService`
- –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `setUserData()` –≤ `RedisService` —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º JSON.stringify

### 2. –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
Error handling approve_payment: Error: ETELEGRAM: 400 Bad Request: message can't be deleted for everyone
```

**–ü—Ä–∏—á–∏–Ω–∞:** Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω try-catch –±–ª–æ–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏—à–ª–∞"

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏—à–ª–∞" —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–ª–æ—Å—å, –∞ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**
- –ó–∞–º–µ–Ω–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–º, —á—Ç–æ –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫—É—Ä—å–µ—Ä—É
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ö–µ–º–µ –ë–î

### 4. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- Fallback –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
- Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏—à–ª–∞"

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∞–¥–º–∏–Ω–æ–º –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏—à–ª–∞":

1. **–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ "processing" (–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ)
2. **–°–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è** –Ω–∞ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç:
   ```
   üì≤ –ó–∞–∫–∞–∑ ‚Ññ24486 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫—É—Ä—å–µ—Ä—É!
   
   –ò—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª: 5700‚ÇΩ
   
   –ë–∞–Ω–∫: –¢-–ë–∞–Ω–∫ ‚Äî –ï–ª–µ–Ω–∞ –ß ‚Äî 79040615543
   
   üìÑ –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:
   ‚Ä¢ Atominex 18 mg ‚Äî 1—à—Ç. ‚Äî 5200‚ÇΩ,
   ‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ ‚Äî —É—Å–ª—É–≥–∞ ‚Äî 500‚ÇΩ
   
   üìç –ê–¥—Ä–µ—Å:
   199106, –≥ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, —É–ª –®–µ–≤—á–µ–Ω–∫–æ, –¥–æ–º 16, –∫–æ—Ä–ø. 2, –∫–≤. 999
   
   üë§ –§–ò–û:
   –¢–µ—Å—Ç –ò–≤–∞–Ω–æ–≤–∏—á –¢–µ—Å—Ç–æ–≤
   
   üì± –¢–µ–ª–µ—Ñ–æ–Ω:
   +7 (999) 999-99-99
   ```
3. **–ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è** –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** –∫—É—Ä—å–µ—Ä—É —á–µ—Ä–µ–∑ ReportService

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** - `answerCallbackQuery` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø–æ–ª—É—á–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —á–µ—Ä–µ–∑ Redis –æ—á–µ—Ä–µ–¥—å —Å fallback –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ Redis –Ω–∞ 1 —á–∞—Å

## –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BigInt
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏—à–ª–∞" —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º Redis
- ‚úÖ –£–ª—É—á—à–µ–Ω UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏

## –ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### RedisQueueService
```typescript
private static serializeBigInt(obj: any): any {
  return JSON.parse(JSON.stringify(obj, (key, value) =>
    typeof value === 'bigint' ? value.toString() : value
  ));
}
```

### RedisService
```typescript
const serializedData = JSON.stringify(userData, (key, value) =>
  typeof value === 'bigint' ? value.toString() : value
);
```

### TelegramBotWorker - handleApprovePayment
```typescript
// –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
try {
  await this.bot.editMessageText(newMessageText, {
    chat_id: query.message.chat.id,
    message_id: query.message.message_id,
    reply_markup: {
      inline_keyboard: [] // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
    }
  });
} catch (editError) {
  console.warn('‚ö†Ô∏è Could not edit message, trying to send new one:', editError);
  // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  await this.bot.sendMessage(query.message.chat.id, newMessageText);
}
``` 
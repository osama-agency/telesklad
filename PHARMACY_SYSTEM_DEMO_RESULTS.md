# Демонстрация системы учета валют и средней закупочной цены

## Результаты тестирования

### 1. Обновление курса валют

✅ **Успешно получен курс TRY от ЦБ РФ:**
- Базовый курс: **20.17 RUB** за 1 TRY
- Курс с буфером 5%: **21.18 RUB** за 1 TRY
- Источник: CBR (Центральный Банк России)
- Дата: 15.06.2025

### 2. Добавление фармацевтических товаров

✅ **Обработано 25 товаров** с автоматическим расчетом себестоимости в рублях:

#### Группа Atominex (7 товаров)
- Atominex 10 mg: 455 TRY = **9,634.94 RUB**
- Atominex 18 mg: 605 TRY = **12,811.30 RUB**
- Atominex 25 mg: 765 TRY = **16,199.41 RUB**
- Atominex 40 mg: 416 TRY = **8,809.09 RUB**
- Atominex 60 mg: 595 TRY = **12,599.54 RUB**
- Atominex 80 mg: 770 TRY = **16,305.29 RUB**
- Atominex 100 mg: 970 TRY = **20,540.43 RUB**

#### Группа Attex (8 товаров)
- Attex 4 mg (сироп): 280 TRY = **5,929.20 RUB**
- Attex 10 mg: 420 TRY = **8,893.79 RUB**
- Attex 18 mg: 740 TRY = **15,670.02 RUB**
- Attex 25 mg: 797 TRY = **16,877.03 RUB**
- Attex 40 mg: 493 TRY = **10,439.62 RUB**
- Attex 60 mg: 730 TRY = **15,458.26 RUB**
- Attex 80 mg: 960 TRY = **20,328.67 RUB**
- Attex 100 mg: 1170 TRY = **24,775.57 RUB**

#### Прочие препараты (10 товаров)
- Abilify 5 mg: 300 TRY = **6,352.71 RUB**
- Abilify 15 mg: 430 TRY = **9,105.55 RUB**
- Arislow 1-4 mg: 255-340 TRY = **5,399.80-7,199.74 RUB**
- HHS A1 L-Carnitine: 280 TRY = **5,929.20 RUB**
- Мирена: 1300 TRY = **27,528.41 RUB**
- Risperdal сироп: 245 TRY = **5,188.05 RUB**
- Salazopyrin: 220 TRY = **4,658.65 RUB**
- Euthyrox: 105 TRY = **2,223.45 RUB**

### 3. Тестовая закупка

✅ **Создана закупка на сумму 38,975 TRY (825,322.91 RUB):**

| Товар | Количество | Цена за ед. (TRY) | Сумма (TRY) | Сумма (RUB) |
|-------|------------|-------------------|-------------|-------------|
| Abilify 5 mg | 50 | 300 | 15,000 | 317,635.50 |
| Attex 10 mg | 30 | 420 | 12,600 | 266,813.82 |
| Atominex 10 mg | 25 | 455 | 11,375 | 240,873.59 |
| **ИТОГО** | **105** | - | **38,975** | **825,322.91** |

**Результат:**
- Остатки товаров увеличены
- Средняя закупочная цена установлена для каждого товара
- Все расчеты выполнены автоматически

### 4. Тестовая продажа и расчет прибыли

✅ **Создан заказ с анализом прибыльности:**

#### Детали заказа:
| Товар | Кол-во | Себестоимость | Цена продажи | Выручка | Прибыль | Маржа |
|-------|--------|---------------|--------------|---------|---------|-------|
| Abilify 5 mg | 5 | 6,352.71 | 8,893.79 | 44,468.97 | 12,705.42 | **28.6%** |
| Attex 10 mg | 3 | 8,893.79 | 13,340.69 | 40,022.06 | 13,340.69 | **33.3%** |
| Atominex 10 mg | 2 | 9,634.94 | 12,525.42 | 25,050.84 | 5,780.96 | **23.1%** |

#### Итоговый анализ прибыли:
- **Валовая выручка:** 109,541.87 RUB
- **Бонус покупателю:** -200.00 RUB
- **Чистая выручка:** 109,341.87 RUB
- **Себестоимость товаров:** 77,714.80 RUB
- **Стоимость доставки:** 500.00 RUB
- **Общие расходы:** 78,214.80 RUB
- **ЧИСТАЯ ПРИБЫЛЬ:** **31,127.07 RUB**
- **МАРЖА ПРИБЫЛИ:** **28.5%**

### 5. Обновление остатков

✅ **Автоматическое списание со склада:**
- Abilify 5 mg: 50 → 45 (-5)
- Attex 10 mg: 75 → 72 (-3)
- Atominex 10 mg: 71 → 69 (-2)

## Ключевые преимущества системы

### 1. **Автоматическая конвертация валют**
- Ежедневное обновление курсов от ЦБ РФ
- Буфер 5% для защиты от колебаний
- Точный расчет себестоимости в рублях

### 2. **Moving Average для себестоимости**
- Учет всех закупок по разным ценам
- Автоматический пересчет при каждой поставке
- Точная себестоимость для расчета прибыли

### 3. **Детальная аналитика прибыли**
- Прибыль по каждому товару
- Учет всех расходов (доставка, бонусы)
- Расчет маржи в реальном времени

### 4. **Полная автоматизация**
- Нет ручного ввода курсов
- Автоматический пересчет цен
- Интеграция с существующей системой

## Технические характеристики

- **База данных:** PostgreSQL с Prisma ORM
- **Курсы валют:** API ЦБ РФ (https://www.cbr-xml-daily.ru/)
- **Cron-задачи:** node-cron для ежедневного обновления
- **Тестирование:** Jest с 9 успешными тестами
- **Точность:** Decimal типы для финансовых расчетов

## Готовность к production

✅ Все компоненты протестированы  
✅ Документация создана  
✅ API endpoints готовы  
✅ Миграции базы данных выполнены  
✅ Система интегрирована с существующим кодом  

**Система готова к использованию в production среде!** 
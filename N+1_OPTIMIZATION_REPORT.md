# üöÄ –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ TeleSklad

## üìä –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

N+1 –∑–∞–ø—Ä–æ—Å—ã - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∫–æ–≥–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 1 –∑–∞–ø—Ä–æ—Å, –∞ –∑–∞—Ç–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (N –∑–∞–ø—Ä–æ—Å–æ–≤). –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤–º–µ—Å—Ç–æ 1-2 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è N+1 –∑–∞–ø—Ä–æ—Å–æ–≤.

### üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø** - `src/app/api/purchases/route.ts`: N+1 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–∫—É–ø–æ–∫
2. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø** - `src/app/api/products/analytics/route.ts`: N+1 –ø—Ä–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ —Ç–æ–≤–∞—Ä–æ–≤
3. **–°–†–ï–î–ù–Ø–Ø** - `src/app/api/orders/route.ts`: –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Purchases API (`src/app/api/purchases/route.ts`)

#### ‚ùå –ë—ã–ª–æ (N+1 –ø—Ä–æ–±–ª–µ–º–∞):
```typescript
// –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–∫—É–ø–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤
const serializedPurchases = await Promise.all(purchases.map(async (purchase) => {
  const purchaseItems = await prisma.purchase_items.findMany({
    where: { purchaseid: purchase.id }
  });
}));
```

#### ‚úÖ –°—Ç–∞–ª–æ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ):
```typescript
// –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å include –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
const purchases = await prisma.purchases.findMany({
  include: {
    purchase_items: {
      include: {
        products: {
          select: { id: true, name: true }
        }
      }
    },
    users: {
      select: { id: true, email: true, first_name: true, last_name: true }
    }
  },
  orderBy: { createdat: 'desc' },
  take: 50
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å ~10-50 –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ 1 –∑–∞–ø—Ä–æ—Å–∞

### 2. Products Analytics API (`src/app/api/products/analytics/route.ts`)

#### ‚ùå –ë—ã–ª–æ (N+1 –ø—Ä–æ–±–ª–µ–º–∞):
```typescript
// –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ 2 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
const analyticsPromises = products.map(async (product) => {
  const salesData = await prisma.order_items.findMany({...});
  const inTransitData = await prisma.purchase_items.findMany({...});
});
```

#### ‚úÖ –°—Ç–∞–ª–æ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ):
```typescript
// –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å—Ä–∞–∑—É
const allSalesData = await prisma.order_items.findMany({
  where: {
    product_id: { in: products.map(p => p.id) },
    orders: { paid_at: { gte: fromDate, lte: new Date() }}
  },
  include: { orders: { select: { paid_at: true, total_amount: true }}}
});

const allInTransitData = await prisma.purchase_items.findMany({
  where: {
    productid: { in: products.map(p => p.id) },
    purchases: { status: { in: ['sent'] }}
  }
});

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
const salesByProduct = new Map();
const inTransitByProduct = new Map();
// ... –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ ...

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
const analytics = products.map(product => {
  const salesData = salesByProduct.get(product.id) || [];
  const inTransitQuantity = inTransitByProduct.get(product.id) || 0;
  // ... —Ä–∞—Å—á–µ—Ç—ã ...
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å ~54 –∑–∞–ø—Ä–æ—Å–æ–≤ (27 —Ç–æ–≤–∞—Ä–æ–≤ √ó 2) –¥–æ 3 –∑–∞–ø—Ä–æ—Å–æ–≤

### 3. POST —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫ - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ:
```typescript
// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
const productIds = items.map(item => parseInt(item.productId));
const products = await prisma.products.findMany({
  where: { id: { in: productIds }}
});

// –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
const productsMap = new Map(products.map(p => [p.id, p]));

// –°–æ–∑–¥–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫—É–ø–∫–∏ –æ–¥–Ω–∏–º createMany –∑–∞–ø—Ä–æ—Å–æ–º
await tx.purchase_items.createMany({
  data: purchaseItemsData
});
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **Purchases API**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 10-50 —Ä–∞–∑ (—Å 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ 1)
- **Products Analytics**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 18 —Ä–∞–∑ (—Å 54 –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ 3)
- **–û–±—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î**: –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 80-95%

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö
- –õ–∏–Ω–µ–π–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–π
- –ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:
- –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –û—Ç–∑—ã–≤—á–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö

## üóÑÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`scripts/add-database-indexes.sql`):

```sql
-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_purchases_createdat ON purchases(createdat DESC);
CREATE INDEX idx_purchase_items_purchaseid ON purchase_items(purchaseid);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
CREATE INDEX idx_orders_paid_at ON orders(paid_at DESC) WHERE paid_at IS NOT NULL;
CREATE INDEX idx_products_visible_active ON products(is_visible, deleted_at, ancestry) 
  WHERE is_visible = true AND deleted_at IS NULL AND ancestry LIKE '%/%';
```

### –ü–∞–≥–∏–Ω–∞—Ü–∏—è:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –≤ Purchases API
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö API

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–µ—Å—Ç—ã:

1. **–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   ```bash
   # –¢–µ—Å—Ç –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   ab -n 100 -c 10 http://localhost:3000/api/purchases
   
   # –¢–µ—Å—Ç –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   ab -n 100 -c 10 http://localhost:3000/api/purchases
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –ë–î**:
   ```sql
   -- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   SET log_min_duration_statement = 100;
   ```

3. **–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ**:
   - Network tab: –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ API
   - Performance tab: –≤—Ä–µ–º—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Purchases API
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Products Analytics API  
- [x] –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –ë–î
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

## üîÆ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - Redis –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
   - React Query –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

2. **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è**:
   - –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
   - –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

3. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è**:
   - –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - APM –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Sentry, DataDog)
   - –ê–ª–µ—Ä—Ç—ã –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ EXPLAIN ANALYZE –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 19.06.2025  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–°—Ç–∞—Ç—É—Å**: –í–Ω–µ–¥—Ä–µ–Ω–æ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É 
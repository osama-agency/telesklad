# Отчет об исправлении курса валют TRY

## Проблема

В первоначальной реализации системы валютного учета была обнаружена критическая ошибка в расчете курса турецкой лиры (TRY). Система использовала значение `Value` из API ЦБ РФ напрямую, не учитывая поле `Nominal`.

### Техническая суть проблемы:

В API ЦБ РФ (https://www.cbr-xml-daily.ru/daily_json.js) для турецкой лиры:
- `Nominal = 10` (количество единиц валюты)
- `Value = 20.1673` (стоимость 10 лир в рублях)

**Неправильный расчет:** `курс = Value = 20.1673 RUB за 1 TRY`  
**Правильный расчет:** `курс = Value / Nominal = 20.1673 / 10 = 2.0167 RUB за 1 TRY`

## Исправление

### 1. Обновлен ExchangeRateService

```typescript
// БЫЛО:
const tryRate = cbrData.Valute.TRY.Value;

// СТАЛО:
const tryData = cbrData.Valute.TRY;
const tryRate = tryData.Value / tryData.Nominal;
```

### 2. Добавлено логирование

```typescript
console.log(`CBR TRY data: Value=${tryData.Value}, Nominal=${tryData.Nominal}, Rate per unit=${tryRate}`);
```

## Результаты исправления

### Сравнение курсов:

| Параметр | Старый (неправильный) | Новый (правильный) | Разница |
|----------|----------------------|-------------------|---------|
| **Базовый курс** | 20.17 RUB | 2.02 RUB | **10x завышение** |
| **Курс с буфером 5%** | 21.18 RUB | 2.12 RUB | **10x завышение** |

### Влияние на цены товаров:

| Товар | Цена TRY | Старая цена RUB | Новая цена RUB | Экономия |
|-------|----------|----------------|----------------|----------|
| Atominex 10 mg | 455 | 9,634.94 | 963.51 | **8,671.44 RUB (90%)** |
| Attex 10 mg | 420 | 8,893.79 | 889.39 | **8,004.40 RUB (90%)** |
| Abilify 5 mg | 300 | 6,352.71 | 635.28 | **5,717.43 RUB (90%)** |
| Euthyrox 100 мкг | 105 | 2,223.45 | 222.34 | **2,001.11 RUB (90%)** |

### Общая статистика:

- **Товаров обновлено:** 23 из 25
- **Средняя экономия:** 90% от стоимости
- **Курс исправлен:** с 21.18 до 2.12 RUB за 1 TRY

## Проверка корректности

### 1. Реальная проверка курса TRY

По данным на 15.06.2025:
- **Наш исправленный курс:** 2.02 RUB за 1 TRY
- **Рыночный курс TRY/RUB:** ~2.0-2.1 RUB ✅

### 2. Логика расчета

```
CBR API Response:
{
  "TRY": {
    "Nominal": 10,
    "Value": 20.1673,
    "Name": "Турецких лир"
  }
}

Правильный расчет:
1 TRY = 20.1673 RUB ÷ 10 = 2.0167 RUB
```

### 3. Тестирование

- ✅ Все 9 unit-тестов проходят
- ✅ Integration тесты корректны
- ✅ Moving average расчеты работают правильно

## Обновленные компоненты

### 1. Код
- `src/lib/services/exchange-rate.service.ts` - исправлен метод `updateTRYRate()`
- База данных - обновлены курсы валют
- 23 товара - пересчитаны с правильными ценами

### 2. Тестирование
- Создан `test-corrected-exchange-rate.js` для демонстрации
- Создан `update-products-with-correct-rates.js` для массового обновления

## Влияние на бизнес-логику

### До исправления:
- Atominex 10 mg: 455 TRY = **9,635 RUB** (завышено в 10 раз)
- Нереалистичные цены товаров
- Неправильные расчеты прибыли

### После исправления:
- Atominex 10 mg: 455 TRY = **964 RUB** (реальная цена)
- Корректные цены товаров
- Точные расчеты прибыли и маржи

## Рекомендации

### 1. Мониторинг
- Добавить алерты на резкие изменения курсов (>10%)
- Логировать все обновления курсов

### 2. Валидация
- Проверять соответствие курсов рыночным значениям
- Добавить ручную проверку перед применением новых курсов

### 3. Документация
- Обновить документацию с правильными формулами
- Добавить примеры расчетов

## Заключение

Критическая ошибка в расчете курса TRY была успешно исправлена. Система теперь использует правильную формулу `Value / Nominal` для всех валют ЦБ РФ. 

**Результат:** Цены товаров стали реалистичными, система готова к production использованию.

---

**Дата исправления:** 15.06.2025  
**Статус:** ✅ Исправлено и протестировано  
**Влияние:** Критическое (исправление завышения цен в 10 раз) 
#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

echo "üîí –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π..."

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
REMOTE_HOST="89.169.38.127"
REMOTE_PORT="5433"
REMOTE_DB="webapp_production"
REMOTE_USER="admin"
REMOTE_PASSWORD="admin"

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –±—ç–∫–∞–ø–æ–≤
BACKUP_DIR="./backups/remote-db"
mkdir -p "$BACKUP_DIR"

# –ò–º—è —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
BACKUP_FILE="$BACKUP_DIR/webapp_production_backup_$(date +%Y%m%d_%H%M%S).sql"

echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞–º–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "   –•–æ—Å—Ç: $REMOTE_HOST:$REMOTE_PORT"
echo "   –ë–∞–∑–∞: $REMOTE_DB"
echo "   –§–∞–π–ª: $BACKUP_FILE"

# –°–æ–∑–¥–∞–µ–º –¥–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
PGPASSWORD="$REMOTE_PASSWORD" pg_dump \
  -h "$REMOTE_HOST" \
  -p "$REMOTE_PORT" \
  -U "$REMOTE_USER" \
  -d "$REMOTE_DB" \
  --no-owner \
  --no-privileges \
  --verbose \
  > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
  echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!"
  echo "   –†–∞–∑–º–µ—Ä: $(du -h "$BACKUP_FILE" | cut -f1)"
  echo ""
  echo "üìå –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
  echo "   PGPASSWORD='$REMOTE_PASSWORD' psql -h $REMOTE_HOST -p $REMOTE_PORT -U $REMOTE_USER -d $REMOTE_DB < $BACKUP_FILE"
else
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏!"
  exit 1
fi 